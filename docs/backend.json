{
  "entities": {
    "AgentLogStep": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AgentLogStep",
      "type": "object",
      "description": "Stores visible logs for every message handled by the agent within a session.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the AgentLogStep entity."
        },
        "sessionId": {
          "type": "string",
          "description": "Reference to Session. (Relationship: Session 1:N AgentLogStep)"
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of the log step.",
          "format": "date-time"
        },
        "userMessage": {
          "type": "string",
          "description": "The message sent by the user."
        },
        "modelResponse": {
          "type": "string",
          "description": "The response generated by the model."
        },
        "reasoning": {
          "type": "string",
          "description": "The reasoning steps taken by the agent."
        },
        "toolCalls": {
          "type": "array",
          "description": "List of tool calls made by the agent.",
          "items": {
            "type": "string"
          }
        },
        "toolResults": {
          "type": "array",
          "description": "Results from the tool calls.",
          "items": {
            "type": "string"
          }
        },
        "finalResponse": {
          "type": "string",
          "description": "The final response generated by the model."
        }
      },
      "required": [
        "id",
        "sessionId",
        "timestamp",
        "userMessage",
        "modelResponse",
        "reasoning",
        "toolCalls",
        "toolResults",
        "finalResponse"
      ]
    },
    "AgentMemoryFact": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AgentMemoryFact",
      "type": "object",
      "description": "Agent-level memory that the MCP agent can read and update.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the AgentMemoryFact entity."
        },
        "sessionId": {
          "type": "string",
          "description": "Reference to Session. (Relationship: Session 1:N AgentMemoryFact)"
        },
        "text": {
          "type": "string",
          "description": "The text content of the fact."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the fact was created.",
          "format": "date-time"
        },
        "source": {
          "type": "string",
          "description": "Source of the fact (tool, user, or agent)."
        }
      },
      "required": [
        "id",
        "sessionId",
        "text",
        "createdAt",
        "source"
      ]
    },
    "ToolMemoryData": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ToolMemoryData",
      "type": "object",
      "description": "Structured namespace for each tool to save data.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ToolMemoryData entity."
        },
        "toolName": {
          "type": "string",
          "description": "Name of the tool this data belongs to."
        },
        "data": {
          "type": "string",
          "description": "The data stored by the tool (can be JSON or string)."
        }
      },
      "required": [
        "id",
        "toolName",
        "data"
      ]
    },
    "TodoItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "TodoItem",
      "type": "object",
      "description": "Represents a to-do item.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the TodoItem entity."
        },
        "text": {
          "type": "string",
          "description": "The text description of the to-do item."
        },
        "completed": {
          "type": "boolean",
          "description": "Indicates if the to-do item is completed."
        }
      },
      "required": [
        "id",
        "text",
        "completed"
      ]
    },
    "Session": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Session",
      "type": "object",
      "description": "Represents a user session.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Session entity."
        },
        "startTime": {
          "type": "string",
          "description": "Timestamp when the session started.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "startTime"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}/sessions/{sessionId}/agent_logs/{stepId}",
        "definition": {
          "entityName": "AgentLogStep",
          "schema": {
            "$ref": "#/backend/entities/AgentLogStep"
          },
          "description": "Stores visible logs for every message handled by the agent within a session.  Owned by the user and session. Path-based ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The ID of the user."
            },
            {
              "name": "sessionId",
              "description": "The ID of the session."
            },
            {
              "name": "stepId",
              "description": "The ID of the agent log step."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/sessions/{sessionId}/agent_memory/{factId}",
        "definition": {
          "entityName": "AgentMemoryFact",
          "schema": {
            "$ref": "#/backend/entities/AgentMemoryFact"
          },
          "description": "Agent-level memory for the MCP agent, scoped to a specific session. Owned by the user and session. Path-based ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The ID of the user."
            },
            {
              "name": "sessionId",
              "description": "The ID of the session."
            },
            {
              "name": "factId",
              "description": "The ID of the agent memory fact."
            }
          ]
        }
      },
      {
        "path": "/tool_memory/{toolName}/{dataId}",
        "definition": {
          "entityName": "ToolMemoryData",
          "schema": {
            "$ref": "#/backend/entities/ToolMemoryData"
          },
          "description": "Structured namespace for each tool to save its data. Tool data is globally accessible.",
          "params": [
            {
              "name": "toolName",
              "description": "The name of the tool."
            },
            {
              "name": "dataId",
              "description": "The ID of the tool memory data."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/todos/{todoId}",
        "definition": {
          "entityName": "TodoItem",
          "schema": {
            "$ref": "#/backend/entities/TodoItem"
          },
          "description": "Stores to-do items for each user. Owned by the user. Path-based ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The ID of the user."
            },
            {
              "name": "todoId",
              "description": "The ID of the to-do item."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/sessions/{sessionId}",
        "definition": {
          "entityName": "Session",
          "schema": {
            "$ref": "#/backend/entities/Session"
          },
          "description": "Represents a user session. Owned by the user. Path-based ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The ID of the user."
            },
            {
              "name": "sessionId",
              "description": "The ID of the session."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support the MCP agent sandbox with a focus on clear logging, memory management, and tool data storage. The structure prioritizes Authorization Independence by avoiding `get()` calls in security rules, relying instead on path-based ownership and denormalized data where necessary. Segregation ensures each collection has a homogeneous security posture. The use of hierarchical paths `/users/{userId}/sessions/{sessionId}` enables secure and efficient ownership-based security rules. The inclusion of 'members' map within the session facilitates collaborative scenarios, enhancing the adaptability of security rules. Each path clearly identifies the entity it represents, supporting easier debugging and maintenance. The predictable schema avoids dynamic keys and enforces strict naming conventions for improved readability and consistency. The structure supports required QAPs, since list operations are secured by the segregation of data based on ownership and the membership model for collaborative scenarios. It maintains invariants through the enforcement of ownership, timestamp, and denormalized data integrity."
  }
}