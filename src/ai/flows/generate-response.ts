'use server';

/**
 * @fileOverview This file defines a Genkit flow for generating a response using the Gemini model,
 * incorporating conversational memory and providing reasoning for its output.
 *
 * @exports generateResponse - A function that generates a response based on user message and memory.
 * @exports GenerateResponseInput - The input type for the generateResponse function.
 * @exports GenerateResponseOutput - The output type for the generateResponse function.
 */

import { ai } from '@/ai/genkit';
import { z } from 'genkit';

// Define schemas for input and output types
const GenerateResponseInputSchema = z.object({
  userMessage: z.string().describe('The user message to be processed.'),
  memory: z
    .array(z.string())
    .describe('A list of facts the agent has remembered from the conversation.'),
});
export type GenerateResponseInput = z.infer<typeof GenerateResponseInputSchema>;

const GenerateResponseOutputSchema = z.object({
  response: z.string().describe('The response generated by the model.'),
  reasoning: z
    .string()
    .describe('The step-by-step reasoning process of the model.'),
  newFacts: z
    .array(z.string())
    .describe(
      'New facts extracted from the current conversation to be saved to memory.'
    ),
});
export type GenerateResponseOutput = z.infer<typeof GenerateResponseOutputSchema>;

// Exported function to call the flow
export async function generateResponse(
  input: GenerateResponseInput
): Promise<GenerateResponseOutput> {
  return generateResponseFlow(input);
}

// Define the prompt
const generateResponsePrompt = ai.definePrompt({
  name: 'generateResponsePrompt',
  input: { schema: GenerateResponseInputSchema },
  output: { schema: GenerateResponseOutputSchema },
  prompt: `You are a helpful assistant with a memory. Your goal is to provide a direct, conversational answer to the user's message while maintaining context.

You have access to a list of facts you've remembered from this conversation. Use them to inform your response.

Your task is to:
1.  **Analyze the user's message:** Understand their question or statement.
2.  **Consult your memory:** Review the provided facts to see if they are relevant to the current message.
3.  **Formulate a response:** Generate a helpful and direct answer. If you use information from your memory, mention it naturally in the conversation.
4.  **Provide your reasoning:** Briefly explain how you arrived at your answer.
5.  **Extract new facts:** Identify any new, simple, and important pieces of information from the user's message or your response. List them as new facts to be added to your memory. If there are no new facts, return an empty array.

- Current Memory/Facts:
{{#if memory}}
{{#each memory}}
- {{{this}}}
{{/each}}
{{else}}
- Memory is empty.
{{/if}}

- User's message:
{{{userMessage}}}
`,
});

// Define the flow
const generateResponseFlow = ai.defineFlow(
  {
    name: 'generateResponseFlow',
    inputSchema: GenerateResponseInputSchema,
    outputSchema: GenerateResponseOutputSchema,
  },
  async (input) => {
    const { output } = await generateResponsePrompt(input);
    return output!;
  }
);
